name: auto-merge

on:
  workflow_call:
    inputs:
      auto-approve:
        description: Automatically approve pull-requests (except breaking changes and maintainer changes)
        default: true
        required: false
        type: boolean
      auto-merge:
        description: Automatically merge pull-requests (when all required checks pass)
        default: false
        required: false
        type: boolean
      command:
        description: The command to pass to Dependabot
        default: "squash and merge"
        required: false
        type: string
      target-repo:
        description: The repo to run this action on. This is to prevent actions from running on forks unless intended.
        required: true
        type: string
    secrets:
      GH_TOKEN:
        description: "Personal access token passed from the caller workflow"
        required: true

# No GITHUB_TOKEN permissions, as we use GH_TOKEN instead.
permissions: {}

jobs:
  auto-merge:
    if: github.repository == inputs.target-repo && github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a # v2.5.0
        with:
          github-token: ${{ secrets.GH_TOKEN }}

      - name: Check for breaking change
        id: check
        env:
          UPDATE_TYPE: ${{ steps.dependabot-metadata.outputs.update-type }}
          PREV_VERSION: ${{ steps.dependabot-metadata.outputs.previous-version }}
          MAINTAINER_CHANGES: ${{ steps.dependabot-metadata.outputs.maintainer-changes }}
        run: |
          eligible=true

          # Major updates are breaking
          if [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
            eligible=false
          # For 0.x versions, minor updates are breaking (semver spec)
          elif [[ "$PREV_VERSION" == 0.* && "$UPDATE_TYPE" == "version-update:semver-minor" ]]; then
            eligible=false
          # For 0.0.x versions, patch updates are breaking (semver spec)
          elif [[ "$PREV_VERSION" == 0.0.* && "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
            eligible=false
          # Package maintainers changed between versions
          elif [[ "$MAINTAINER_CHANGES" == "true" ]]; then
            eligible=false
          fi

          echo "eligible=$eligible" >> $GITHUB_OUTPUT

      - name: Approve
        if: inputs.auto-approve && steps.check.outputs.eligible == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh pr review ${{ github.event.pull_request.html_url }} --approve

      - name: Merge
        if: inputs.auto-merge && steps.check.outputs.eligible == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh pr merge ${{ github.event.pull_request.html_url }} --auto --squash
